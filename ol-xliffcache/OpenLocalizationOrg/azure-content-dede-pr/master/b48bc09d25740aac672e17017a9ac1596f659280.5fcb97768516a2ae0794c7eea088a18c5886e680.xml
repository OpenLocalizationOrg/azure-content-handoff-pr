{"nodes":[{"content":"Visual Studio templates for Azure Batch | Microsoft Azure","pos":[27,84]},{"content":"Learn how these Visual Studio project templates can help you implement and run your compute-intensive workloads on Azure Batch","pos":[103,229]},{"content":"Visual Studio project templates for Azure Batch","pos":[535,582]},{"content":"The <bpt id=\"p1\">**</bpt>Job Manager<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Task Processor Visual Studio templates<ept id=\"p2\">**</ept> for Batch provide code to help you to implement and run your compute-intensive workloads on Batch with the least amount of effort.","pos":[584,781],"source":"The **Job Manager** and **Task Processor Visual Studio templates** for Batch provide code to help you to implement and run your compute-intensive workloads on Batch with the least amount of effort."},{"content":"This document describes these templates and provides guidance for how to use them.","pos":[782,864]},{"content":"This article discusses only information applicable to these two templates, and assumes that you are familiar with the Batch service and key concepts related to it: pools, compute nodes, jobs and tasks, job manager tasks, environment variables, and other relevant information.","pos":[885,1160]},{"content":"You can find more information in <bpt id=\"p1\">[</bpt>Basics of Azure Batch<ept id=\"p1\">](batch-technical-overview.md)</ept>, <bpt id=\"p2\">[</bpt>Batch feature overview for developers<ept id=\"p2\">](batch-api-basics.md)</ept>, and <bpt id=\"p3\">[</bpt>Get started with the Azure Batch library for .NET<ept id=\"p3\">](batch-dotnet-get-started.md)</ept>.","pos":[1161,1395],"source":" You can find more information in [Basics of Azure Batch](batch-technical-overview.md), [Batch feature overview for developers](batch-api-basics.md), and [Get started with the Azure Batch library for .NET](batch-dotnet-get-started.md)."},{"content":"High-level overview","pos":[1400,1419]},{"content":"The Job Manager and Task Processor templates can be used to create two useful components:","pos":[1421,1510]},{"content":"A job manager task that implements a job splitter that can break a job down into multiple tasks that can run independently, in parallel.","pos":[1514,1650]},{"content":"A task processor that can be used to perform pre-processing and post-processing around an application command line.","pos":[1654,1769]},{"content":"For example, in a movie rendering scenario, the job splitter would turn a single movie job into hundreds or thousands of separate tasks that would process individual frames separately.","pos":[1771,1955]},{"content":"Correspondingly, the task processor would invoke the rendering application and all dependent processes that are needed to render each frame, as well as perform any additional actions (for example, copying the rendered frame to a storage location).","pos":[1956,2203]},{"pos":[2219,2421],"content":"The Job Manager and Task Processor templates are independent of each other, so you can choose to use both, or only one of them, depending on the requirements of your compute job and on your preferences."},{"content":"As shown in the diagram below, a compute job that uses these templates will go through three stages:","pos":[2423,2523]},{"content":"The client code (e.g., application, web service, etc.) submits a job to the Batch service on Azure, specifying as its job manager task the job manager program.","pos":[2528,2687]},{"content":"The Batch service runs the job manager task on a compute node and the job splitter launches the specified number of task processor tasks, on as many compute nodes as required, based on the parameters and specifications in the job splitter code.","pos":[2692,2936]},{"content":"The task processor tasks run independently, in parallel, to process the input data and generate the output data.","pos":[2941,3053]},{"content":"Diagram showing how client code interacts with the Batch service","pos":[3057,3121]},{"content":"Prerequisites","pos":[3138,3151]},{"content":"To use the Batch templates, you will need the following:","pos":[3153,3209]},{"content":"A computer with Visual Studio 2015, or newer, already installed on it.","pos":[3213,3283]},{"content":"The Batch templates, which are available from the <bpt id=\"p1\">[</bpt>Visual Studio Gallery<ept id=\"p1\">]</ept><bpt id=\"p2\">[</bpt>vs_gallery<ept id=\"p2\">]</ept> as Visual Studio extensions.","pos":[3287,3401],"source":"The Batch templates, which are available from the [Visual Studio Gallery][vs_gallery] as Visual Studio extensions."},{"content":"There are two ways to get the templates:","pos":[3402,3442]},{"content":"Install the templates using the <bpt id=\"p1\">**</bpt>Extensions and Updates<ept id=\"p1\">**</ept> dialog box in Visual Studio (for more information, see <bpt id=\"p2\">[</bpt>Finding and Using Visual Studio Extensions<ept id=\"p2\">]</ept><bpt id=\"p3\">[</bpt>vs_find_use_ext<ept id=\"p3\">]</ept>).","pos":[3448,3625],"source":"Install the templates using the **Extensions and Updates** dialog box in Visual Studio (for more information, see [Finding and Using Visual Studio Extensions][vs_find_use_ext])."},{"content":"In the <bpt id=\"p1\">**</bpt>Extensions and Updates<ept id=\"p1\">**</ept> dialog box, search and download the following two extensions:","pos":[3626,3721],"source":" In the **Extensions and Updates** dialog box, search and download the following two extensions:"},{"content":"Azure Batch Job Manager with Job Splitter","pos":[3729,3770]},{"content":"Azure Batch Task Processor","pos":[3777,3803]},{"pos":[3809,3938],"content":"Download the templates from the online gallery for Visual Studio: <bpt id=\"p1\">[</bpt>Microsoft Azure Batch Project Templates<ept id=\"p1\">]</ept><bpt id=\"p2\">[</bpt>vs_gallery_templates<ept id=\"p2\">]</ept>","source":"Download the templates from the online gallery for Visual Studio: [Microsoft Azure Batch Project Templates][vs_gallery_templates]"},{"pos":[3942,4157],"content":"If you plan to use the <bpt id=\"p1\">[</bpt>Application Packages<ept id=\"p1\">](batch-application-packages.md)</ept> feature to deploy the job manager and task processor to the Batch compute nodes, you need to link a storage account to your Batch account.","source":"If you plan to use the [Application Packages](batch-application-packages.md) feature to deploy the job manager and task processor to the Batch compute nodes, you need to link a storage account to your Batch account."},{"content":"Preparation","pos":[4162,4173]},{"content":"We recommend creating a solution that can contain your job manager as well as your task processor, because this can make it easier to share code between your job manager and task processor programs.","pos":[4175,4373]},{"content":"To create this solution, follow these steps:","pos":[4374,4418]},{"pos":[4423,4491],"content":"Open Visual Studio 2015 and select <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept><ph id=\"ph1\"> &gt; </ph><bpt id=\"p2\">**</bpt>New<ept id=\"p2\">**</ept><ph id=\"ph2\"> &gt; </ph><bpt id=\"p3\">**</bpt>Project<ept id=\"p3\">**</ept>.","source":"Open Visual Studio 2015 and select **File** > **New** > **Project**."},{"pos":[4496,4619],"content":"Under <bpt id=\"p1\">**</bpt>Templates<ept id=\"p1\">**</ept>, expand <bpt id=\"p2\">**</bpt>Other Project Types<ept id=\"p2\">**</ept>, click <bpt id=\"p3\">**</bpt>Visual Studio Solutions<ept id=\"p3\">**</ept>, and then select <bpt id=\"p4\">**</bpt>Blank Solution<ept id=\"p4\">**</ept>.","source":"Under **Templates**, expand **Other Project Types**, click **Visual Studio Solutions**, and then select **Blank Solution**."},{"content":"Type a name that describes your application and the purpose of this solution (e.g., \"LitwareBatchTaskPrograms\").","pos":[4624,4736]},{"pos":[4741,4782],"content":"To create the new solution, click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.","source":"To create the new solution, click **OK**."},{"content":"Job Manager template","pos":[4787,4807]},{"content":"The Job Manager template helps you to implement a job manager task that can perform the following actions:","pos":[4809,4915]},{"content":"Split a job into multiple tasks.","pos":[4919,4951]},{"content":"Submit those tasks to run on Batch.","pos":[4954,4989]},{"pos":[5005,5133],"content":"For more information about job manager tasks, see <bpt id=\"p1\">[</bpt>Batch feature overview for developers<ept id=\"p1\">](batch-api-basics.md#job-manager-task)</ept>.","source":" For more information about job manager tasks, see [Batch feature overview for developers](batch-api-basics.md#job-manager-task)."},{"content":"Create a Job Manager using the template","pos":[5139,5178]},{"content":"To add a job manager to the solution that you created earlier, follow these steps:","pos":[5180,5262]},{"content":"Open your existing solution in Visual Studio 2015.","pos":[5267,5317]},{"pos":[5322,5402],"content":"In Solution Explorer, right-click the solution, click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept><ph id=\"ph1\"> &gt; </ph><bpt id=\"p2\">**</bpt>New Project<ept id=\"p2\">**</ept>.","source":"In Solution Explorer, right-click the solution, click **Add** > **New Project**."},{"pos":[5407,5506],"content":"Under <bpt id=\"p1\">**</bpt>Visual C#<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Cloud<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Azure Batch Job Manager with Job Splitter<ept id=\"p3\">**</ept>.","source":"Under **Visual C#**, click **Cloud**, and then click **Azure Batch Job Manager with Job Splitter**."},{"content":"Type a name that describes your application and identifies this project as the job manager (e.g. \"LitwareJobManager\").","pos":[5511,5629]},{"pos":[5634,5670],"content":"To create the project, click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.","source":"To create the project, click **OK**."},{"content":"Finally, build the project to force Visual Studio to load all referenced NuGet packages and to verify that the project is valid before you start modifying it.","pos":[5675,5833]},{"content":"Job Manager template files and their purpose","pos":[5839,5883]},{"content":"When you create a project using the Job Manager template, it generates three groups of code files:","pos":[5885,5983]},{"content":"The main program file (Program.cs).","pos":[5987,6022]},{"content":"This contains the program entry point and top-level exception handling.","pos":[6023,6094]},{"content":"You shouldn't normally need to modify this.","pos":[6095,6138]},{"content":"The Framework directory.","pos":[6142,6166]},{"content":"This contains the files responsible for the 'boilerplate' work done by the job manager program – unpacking parameters, adding tasks to the Batch job, etc. You shouldn't normally need to modify these files.","pos":[6167,6372]},{"content":"The job splitter file (JobSplitter.cs).","pos":[6376,6415]},{"content":"This is where you will put your application-specific logic for splitting a job into tasks.","pos":[6416,6506]},{"content":"Of course you can add additional files as required to support your job splitter code, depending on the complexity of the job splitting logic.","pos":[6508,6649]},{"content":"The template also generates standard .NET project files such as a .csproj file, app.config, packages.config, etc.","pos":[6651,6764]},{"content":"The rest of this section describes the different files and their code structure, and explains what each class does.","pos":[6766,6881]},{"content":"Visual Studio Solution Explorer showing the Job Manager template solution","pos":[6885,6958]},{"content":"Framework files","pos":[6984,6999]},{"content":": Encapsulates the loading of job configuration data such as Batch account details, linked storage account credentials, job and task information, and job parameters.","pos":[7023,7188]},{"content":"It also provides access to Batch-defined environment variables (see Environment settings for tasks, in the Batch documentation) via the Configuration.EnvironmentVariable class.","pos":[7189,7365]},{"pos":[7388,7533],"content":": Abstracts the implementation of the Configuration class, so that you can unit test your job splitter using a fake or mock configuration object."},{"content":": Orchestrates the components of the job manager program.","pos":[7552,7609]},{"content":"It is responsible for the initializing the job splitter, invoking the job splitter, and dispatching the tasks returned by the job splitter to the task submitter.","pos":[7610,7771]},{"content":": Represents an error that requires the job manager to terminate.","pos":[7799,7864]},{"content":"JobManagerException is used to wrap 'expected' errors where specific diagnostic information can be provided as part of termination.","pos":[7865,7996]},{"content":": This class is responsible to adding tasks returned by the job splitter to the Batch job.","pos":[8018,8108]},{"content":"The JobManager class aggregates the sequence of tasks into batches for efficient but timely addition to the job, then calls TaskSubmitter.SubmitTasks on a background thread for each batch.","pos":[8109,8297]},{"content":"Job Splitter","pos":[8301,8313]},{"content":": This class contains application-specific logic for splitting the job into tasks.","pos":[8333,8415]},{"content":"The framework invokes the JobSplitter.Split method to obtain a sequence of tasks, which it adds to the job as the method returns them.","pos":[8416,8550]},{"content":"This is the class where you will inject the logic of your job.","pos":[8551,8613]},{"content":"Implement the Split method to return a sequence of CloudTask instances representing the tasks into which you want to partition the job.","pos":[8614,8749]},{"content":"Standard .NET command line project files","pos":[8753,8793]},{"pos":[8811,8858],"content":": Standard .NET application configuration file."},{"pos":[8879,8920],"content":": Standard NuGet package dependency file."},{"pos":[8936,9004],"content":": Contains the program entry point and top-level exception handling."},{"content":"Implementing the job splitter","pos":[9010,9039]},{"content":"When you open the Job Manager template project, the project will have the JobSplitter.cs file open by default.","pos":[9041,9151]},{"content":"You can implement the split logic for the tasks in your workload by using the Split() method show below:","pos":[9152,9256]},{"content":"The annotated section in the <ph id=\"ph1\">`Split()`</ph> method is the only section of the Job Manager template code that is intended for you to modify by adding the logic to split your jobs into different tasks.","pos":[10314,10508],"source":" The annotated section in the `Split()` method is the only section of the Job Manager template code that is intended for you to modify by adding the logic to split your jobs into different tasks."},{"content":"If you want to modify a different section of the template, please ensure you are familiarized with how Batch works, and try out a few of the <bpt id=\"p1\">[</bpt>Batch code samples<ept id=\"p1\">]</ept><bpt id=\"p2\">[</bpt>github_samples<ept id=\"p2\">]</ept>.","pos":[10509,10687],"source":" If you want to modify a different section of the template, please ensure you are familiarized with how Batch works, and try out a few of the [Batch code samples][github_samples]."},{"content":"Your Split() implementation has access to:","pos":[10689,10731]},{"pos":[10735,10783],"content":"The job parameters, via the <ph id=\"ph1\">`_parameters`</ph> field.","source":"The job parameters, via the `_parameters` field."},{"pos":[10786,10849],"content":"The CloudJob object representing the job, via the <ph id=\"ph1\">`_job`</ph> field.","source":"The CloudJob object representing the job, via the `_job` field."},{"pos":[10852,10940],"content":"The CloudTask object representing the job manager task, via the <ph id=\"ph1\">`_jobManagerTask`</ph> field.","source":"The CloudTask object representing the job manager task, via the `_jobManagerTask` field."},{"content":"Your <ph id=\"ph1\">`Split()`</ph> implementation does not need to add tasks to the job directly.","pos":[10942,11019],"source":"Your `Split()` implementation does not need to add tasks to the job directly."},{"content":"Instead, your code should return a sequence of CloudTask objects, and these will be added to the job automatically by the framework classes that invoke the job splitter.","pos":[11020,11189]},{"content":"It's common to use C#'s iterator (<ph id=\"ph1\">`yield return`</ph>) feature to implement job splitters as this allows the tasks to start running as soon as possible rather than waiting for all tasks to be calculated.","pos":[11190,11388],"source":" It's common to use C#'s iterator (`yield return`) feature to implement job splitters as this allows the tasks to start running as soon as possible rather than waiting for all tasks to be calculated."},{"content":"Job splitter failure","pos":[11392,11412]},{"content":"If your job splitter encounters an error, it should either:","pos":[11416,11475]},{"pos":[11479,11603],"content":"Terminate the sequence using the C# <ph id=\"ph1\">`yield break`</ph> statement, in which case the job manager will be treated as successful; or","source":"Terminate the sequence using the C# `yield break` statement, in which case the job manager will be treated as successful; or"},{"content":"Throw an exception, in which case the job manager will be treated as failed and may be retried depending on how the client has configured it).","pos":[11607,11749]},{"content":"In both cases, any tasks already returned by the job splitter and added to the Batch job will be eligible to run.","pos":[11751,11864]},{"content":"If you don't want this to happen, then you could:","pos":[11865,11914]},{"content":"Terminate the job before returning from the job splitter","pos":[11918,11974]},{"pos":[11978,12164],"content":"Formulate the entire task collection before returning it (that is, return an <ph id=\"ph1\">`ICollection&lt;CloudTask&gt;`</ph> or <ph id=\"ph2\">`IList&lt;CloudTask&gt;`</ph> instead of implementing your job splitter using a C# iterator)","source":"Formulate the entire task collection before returning it (that is, return an `ICollection<CloudTask>` or `IList<CloudTask>` instead of implementing your job splitter using a C# iterator)"},{"content":"Use task dependencies to make all tasks depend on the successful completion of the job manager","pos":[12168,12262]},{"content":"Job manager retries","pos":[12266,12285]},{"content":"If the job manager fails, it may be retried by the Batch service depending on the client retry settings.","pos":[12289,12393]},{"content":"In general, this is safe, because when the framework adds tasks to the job, it ignores any tasks that already exist.","pos":[12394,12510]},{"content":"However, if calculating tasks is expensive, you may not wish to incur the cost of recalculating tasks that have already been added to the job; conversely, if the re-run is not guaranteed to generate the same task IDs then the 'ignore duplicates' behavior will not kick in.","pos":[12511,12783]},{"content":"In these cases you should design your job splitter to detect the work that has already been done and not repeat it, for example by performing a CloudJob.ListTasks before starting to yield tasks.","pos":[12784,12978]},{"content":"Exit codes and exceptions in the Job Manager template","pos":[12984,13037]},{"content":"Exit codes and exceptions provide a mechanism to determine the outcome of running a program, and they can help to identify any problems with the execution of the program.","pos":[13039,13209]},{"content":"The Job Manager template implements the exit codes and exceptions described in this section.","pos":[13210,13302]},{"content":"A job manager task that is implemented with the Job Manager template can return three possible exit codes:","pos":[13304,13410]},{"content":"Code","pos":[13414,13418]},{"content":"Description","pos":[13421,13432]},{"content":"0","pos":[13460,13461]},{"content":"The job manager completed successfully.","pos":[13467,13506]},{"content":"Your job splitter code ran to completion, and all tasks were added to the job.","pos":[13507,13585]},{"content":"1","pos":[13590,13591]},{"content":"The job manager task failed with an exception in an 'expected' part of the program.","pos":[13597,13680]},{"content":"The exception was translated to a JobManagerException with diagnostic information and, where possible, suggestions for resolving the failure.","pos":[13681,13822]},{"content":"2","pos":[13827,13828]},{"content":"The job manager task failed with an 'unexpected' exception.","pos":[13834,13893]},{"content":"The exception was logged to standard output, but the job manager was unable to add any additional diagnostic or remediation information.","pos":[13894,14030]},{"content":"In the case of job manager task failure, some tasks may still have been added to the service before the error occurred.","pos":[14034,14153]},{"content":"These tasks will run as normal.","pos":[14154,14185]},{"content":"See \"Job Splitter Failure\" above for discussion of this code path.","pos":[14186,14252]},{"content":"All the information returned by exceptions is written into stdout.txt and stderr.txt files.","pos":[14254,14345]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Error Handling<ept id=\"p1\">](batch-api-basics.md#error-handling)</ept>.","pos":[14346,14425],"source":" For more information, see [Error Handling](batch-api-basics.md#error-handling)."},{"content":"Client considerations","pos":[14431,14452]},{"content":"This section describes some client implementation requirements when invoking a job manager based on this template.","pos":[14454,14568]},{"content":"See <bpt id=\"p1\">[</bpt>How to pass parameters and environment variables from the client code<ept id=\"p1\">](#pass-environment-settings)</ept> for details on passing parameters and environment settings.","pos":[14569,14732],"source":" See [How to pass parameters and environment variables from the client code](#pass-environment-settings) for details on passing parameters and environment settings."},{"content":"Mandatory credentials","pos":[14736,14757]},{"content":"In order to add tasks to the Azure Batch job, the job manager task requires your Azure Batch account URL and key.","pos":[14761,14874]},{"content":"You must pass these in environment variables named YOUR_BATCH_URL and YOUR_BATCH_KEY.","pos":[14875,14960]},{"content":"You can set these in the Job Manager task environment settings.","pos":[14961,15024]},{"content":"For example, in a C# client:","pos":[15025,15053]},{"content":"Storage credentials","pos":[15295,15314]},{"content":"Typically, the client does not need to provide the linked storage account credentials to the job manager task because (a) most job managers do not need to explicitly access the linked storage account and (b) the linked storage account is often provided to all tasks as a common environment setting for the job.","pos":[15318,15628]},{"content":"If you are not providing the linked storage account via the common environment settings, and the job manager requires access to linked storage, then you should supply the linked storage credentials as follows:","pos":[15629,15838]},{"content":"Job manager task settings","pos":[16098,16123]},{"pos":[16127,16205],"content":"The client should set the job manager <bpt id=\"p1\">*</bpt>killJobOnCompletion<ept id=\"p1\">*</ept> flag to <bpt id=\"p2\">**</bpt>false<ept id=\"p2\">**</ept>.","source":"The client should set the job manager *killJobOnCompletion* flag to **false**."},{"pos":[16207,16276],"content":"It is usually safe for the client to set <bpt id=\"p1\">*</bpt>runExclusive<ept id=\"p1\">*</ept> to <bpt id=\"p2\">**</bpt>false<ept id=\"p2\">**</ept>.","source":"It is usually safe for the client to set *runExclusive* to **false**."},{"pos":[16278,16453],"content":"The client should use the <bpt id=\"p1\">*</bpt>resourceFiles<ept id=\"p1\">*</ept> or <bpt id=\"p2\">*</bpt>applicationPackageReferences<ept id=\"p2\">*</ept> collection to have the job manager executable (and its required DLLs) deployed to the compute node.","source":"The client should use the *resourceFiles* or *applicationPackageReferences* collection to have the job manager executable (and its required DLLs) deployed to the compute node."},{"content":"By default, the job manager will not be retried if it fails.","pos":[16455,16515]},{"content":"Depending on your job manager logic, the client may want to enable retries via <bpt id=\"p1\">*</bpt>constraints<ept id=\"p1\">*</ept><ph id=\"ph1\">/</ph><bpt id=\"p2\">*</bpt>maxTaskRetryCount<ept id=\"p2\">*</ept>.","pos":[16516,16629],"source":" Depending on your job manager logic, the client may want to enable retries via *constraints*/*maxTaskRetryCount*."},{"content":"Job settings","pos":[16633,16645]},{"content":"If the job splitter emits tasks with dependencies, the client must set the job's usesTaskDependencies to true.","pos":[16649,16759]},{"content":"In the job splitter model, it is unusual for clients to wish to add tasks to jobs over and above what the job splitter creates.","pos":[16761,16888]},{"content":"The client should therefore normally set the job's <bpt id=\"p1\">*</bpt>onAllTasksComplete<ept id=\"p1\">*</ept> to <bpt id=\"p2\">**</bpt>terminatejob<ept id=\"p2\">**</ept>.","pos":[16889,16981],"source":" The client should therefore normally set the job's *onAllTasksComplete* to **terminatejob**."},{"content":"Task Processor template","pos":[16986,17009]},{"content":"A Task Processor template helps you to implement a task processor that can perform the following actions:","pos":[17011,17116]},{"content":"Set up the information required by each Batch task to run.","pos":[17120,17178]},{"content":"Run all actions required by each Batch task.","pos":[17181,17225]},{"content":"Save task outputs to persistent storage.","pos":[17228,17268]},{"content":"Although a task processor is not required to run tasks on Batch, the key advantage of using a task processor is that it provides a wrapper to implement all task execution actions in one location.","pos":[17270,17465]},{"content":"For example, if you need to run several applications in the context of each task, or if you need to copy data to persistent storage after completing each task.","pos":[17466,17625]},{"content":"The actions performed by the task processor can be as simple or complex, and as many or as few, as required by your workload.","pos":[17627,17752]},{"content":"Additionally, by implementing all task actions into one task processor, you can readily update or add actions based on changes to applications or workload requirements.","pos":[17753,17921]},{"content":"However, in some cases a task processor might not be the optimal solution for your implementation as it can add unnecessary complexity, for example when running jobs that can be quickly started from a simple command line.","pos":[17922,18143]},{"content":"Create a Task Processor using the template","pos":[18149,18191]},{"content":"To add a task processor to the solution that you created earlier, follow these steps:","pos":[18193,18278]},{"content":"Open your existing solution in Visual Studio 2015.","pos":[18283,18333]},{"pos":[18338,18432],"content":"In Solution Explorer, right-click the solution, click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>New Project<ept id=\"p2\">**</ept>.","source":"In Solution Explorer, right-click the solution, click **Add**, and then click **New Project**."},{"pos":[18437,18521],"content":"Under <bpt id=\"p1\">**</bpt>Visual C#<ept id=\"p1\">**</ept>, click <bpt id=\"p2\">**</bpt>Cloud<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Azure Batch Task Processor<ept id=\"p3\">**</ept>.","source":"Under **Visual C#**, click **Cloud**, and then click **Azure Batch Task Processor**."},{"content":"Type a name that describes your application and identifies this project as the task processor (e.g. \"LitwareTaskProcessor\").","pos":[18526,18650]},{"pos":[18655,18691],"content":"To create the project, click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.","source":"To create the project, click **OK**."},{"content":"Finally, build the project to force Visual Studio to load all referenced NuGet packages and to verify that the project is valid before you start modifying it.","pos":[18696,18854]},{"content":"Task Processor template files and their purpose","pos":[18860,18907]},{"content":"When you create a project using the task processor template, it generates three groups of code files:","pos":[18909,19010]},{"content":"The main program file (Program.cs).","pos":[19014,19049]},{"content":"This contains the program entry point and top-level exception handling.","pos":[19050,19121]},{"content":"You shouldn't normally need to modify this.","pos":[19122,19165]},{"content":"The Framework directory.","pos":[19169,19193]},{"content":"This contains the files responsible for the 'boilerplate' work done by the job manager program – unpacking parameters, adding tasks to the Batch job, etc. You shouldn't normally need to modify these files.","pos":[19194,19399]},{"content":"The task processor file (TaskProcessor.cs).","pos":[19403,19446]},{"content":"This is where you will put your application-specific logic for executing a task (typically by calling out to an existing executable).","pos":[19447,19580]},{"content":"Pre- and post-processing code, such as downloading additional data or uploading result files, also goes here.","pos":[19581,19690]},{"content":"Of course you can add additional files as required to support your task processor code, depending on the complexity of the job splitting logic.","pos":[19692,19835]},{"content":"The template also generates standard .NET project files such as a .csproj file, app.config, packages.config, etc.","pos":[19837,19950]},{"content":"The rest of this section describes the different files and their code structure, and explains what each class does.","pos":[19952,20067]},{"content":"Visual Studio Solution Explorer showing the Task Processor template solution","pos":[20071,20147]},{"content":"Framework files","pos":[20173,20188]},{"content":": Encapsulates the loading of job configuration data such as Batch account details, linked storage account credentials, job and task information, and job parameters.","pos":[20212,20377]},{"content":"It also provides access to Batch-defined environment variables (see Environment settings for tasks, in the Batch documentation) via the Configuration.EnvironmentVariable class.","pos":[20378,20554]},{"pos":[20577,20722],"content":": Abstracts the implementation of the Configuration class, so that you can unit test your job splitter using a fake or mock configuration object."},{"content":": Represents an error that requires the job manager to terminate.","pos":[20753,20818]},{"content":"TaskProcessorException is used to wrap 'expected' errors where specific diagnostic information can be provided as part of termination.","pos":[20819,20953]},{"content":"Task Processor","pos":[20957,20971]},{"content":": Runs the task.","pos":[20995,21011]},{"content":"The framework invokes the TaskProcessor.Run method.","pos":[21012,21063]},{"content":"This is the class where you will inject the application-specific logic of your task.","pos":[21064,21148]},{"content":"Implement the Run method to:","pos":[21149,21177]},{"content":"Parse and validate any task parameters","pos":[21182,21220]},{"content":"Compose the command line for any external program you want to invoke","pos":[21225,21293]},{"content":"Log any diagnostic information you may require for debugging purposes","pos":[21298,21367]},{"content":"Start a process using that command line","pos":[21372,21411]},{"content":"Wait for the process to exit","pos":[21416,21444]},{"content":"Capture the exit code of the process to determine if it succeeded or failed","pos":[21449,21524]},{"content":"Save any output files you want to keep to persistent storage","pos":[21529,21589]},{"content":"Standard .NET command line project files","pos":[21593,21633]},{"pos":[21651,21698],"content":": Standard .NET application configuration file."},{"pos":[21718,21759],"content":": Standard NuGet package dependency file."},{"pos":[21774,21842],"content":": Contains the program entry point and top-level exception handling."},{"content":"Implementing the task processor","pos":[21847,21878]},{"content":"When you open the Task Processor template project, the project will have the TaskProcessor.cs file open by default.","pos":[21880,21995]},{"content":"You can implement the run logic for the tasks in your workload by using the Run() method shown below:","pos":[21996,22097]},{"content":"The annotated section in the Run() method is the only section of the Task Processor template code that is intended for you to modify by adding the run logic for the tasks in your workload.","pos":[23504,23692]},{"content":"If you want to modify a different section of the template, please first familiarize yourself with how Batch works by reviewing the Batch documentation and trying out a few of the Batch code samples.","pos":[23693,23891]},{"content":"The Run() method is responsible for launching the command line, starting one or more processes, waiting for all process to complete, saving the results, and finally returning with an exit code.","pos":[23893,24086]},{"content":"The Run() method is where you implement the processing logic for your tasks.","pos":[24087,24163]},{"content":"The task processor framework invokes the Run() method for you; you do not need to call it yourself.","pos":[24164,24263]},{"content":"Your Run() implementation has access to:","pos":[24265,24305]},{"pos":[24309,24358],"content":"The task parameters, via the <ph id=\"ph1\">`_parameters`</ph> field.","source":"The task parameters, via the `_parameters` field."},{"pos":[24361,24421],"content":"The job and task ids, via the <ph id=\"ph1\">`_jobId`</ph> and <ph id=\"ph2\">`_taskId`</ph> fields.","source":"The job and task ids, via the `_jobId` and `_taskId` fields."},{"pos":[24424,24479],"content":"The task configuration, via the <ph id=\"ph1\">`_configuration`</ph> field.","source":"The task configuration, via the `_configuration` field."},{"content":"Task failure","pos":[24483,24495]},{"content":"In case of failure, you can exit the Run() method by throwing an exception, but this leaves the top level exception handler in control of the task exit code.","pos":[24499,24656]},{"content":"If you need to control the exit code so that you can distinguish different types of failure, for example for diagnostic purposes or because some failure modes should terminate the job and others should not, then you should exit the Run() method by returning a non-zero exit code.","pos":[24657,24936]},{"content":"This becomes the task exit code.","pos":[24937,24969]},{"content":"Exit codes and exceptions in the Task Processor template","pos":[24975,25031]},{"content":"Exit codes and exceptions provide a mechanism to determine the outcome of running a program, and they can help identify any problems with the execution of the program.","pos":[25033,25200]},{"content":"The Task Processor template implements the exit codes and exceptions described in this section.","pos":[25201,25296]},{"content":"A task processor task that is implemented with the Task Processor template can return three possible exit codes:","pos":[25298,25410]},{"content":"Code","pos":[25414,25418]},{"content":"Description","pos":[25421,25432]},{"pos":[25461,25497],"content":"<bpt id=\"p1\">[</bpt>Process.ExitCode<ept id=\"p1\">]</ept><bpt id=\"p2\">[</bpt>process_exitcode<ept id=\"p2\">]</ept>","source":"[Process.ExitCode][process_exitcode]"},{"content":"The task processor ran to completion.","pos":[25500,25537]},{"content":"Note that this does not imply that the program you invoked was successful – only that the task processor invoked it successfully and performed any post-processing without exceptions.","pos":[25538,25720]},{"content":"The meaning of the exit code depends on the invoked program – typically exit code 0 means the program succeeded and any other exit code means the program failed.","pos":[25721,25882]},{"content":"1","pos":[25887,25888]},{"content":"The task processor failed with an exception in an 'expected' part of the program.","pos":[25894,25975]},{"content":"The exception was translated to a <ph id=\"ph1\">`TaskProcessorException`</ph> with diagnostic information and, where possible, suggestions for resolving the failure.","pos":[25976,26122],"source":" The exception was translated to a `TaskProcessorException` with diagnostic information and, where possible, suggestions for resolving the failure."},{"content":"2","pos":[26127,26128]},{"content":"The task processor failed with an 'unexpected' exception.","pos":[26134,26191]},{"content":"The exception was logged to standard output, but the task processor was unable to add any additional diagnostic or remediation information.","pos":[26192,26331]},{"content":"If the program you invoke uses exit codes 1 and 2 to indicate specific failure modes, then using exit codes 1 and 2 for task processor errors is ambiguous.","pos":[26349,26504]},{"content":"You can change these task processor error codes to distinctive exit codes by editing the exception cases in the Program.cs file.","pos":[26505,26633]},{"content":"All the information returned by exceptions is written into stdout.txt and stderr.txt files.","pos":[26635,26726]},{"content":"For more information, see Error Handling, in the Batch documentation.","pos":[26727,26796]},{"content":"Client considerations","pos":[26802,26823]},{"content":"Storage credentials","pos":[26827,26846]},{"content":"If your task processor uses Azure blob storage to persist outputs, for example using the file conventions helper library, then it needs access to <bpt id=\"p1\">*</bpt>either<ept id=\"p1\">*</ept> the cloud storage account credentials <bpt id=\"p2\">*</bpt>or<ept id=\"p2\">*</ept> a blob container URL that includes a shared access signature (SAS).","pos":[26850,27115],"source":"If your task processor uses Azure blob storage to persist outputs, for example using the file conventions helper library, then it needs access to *either* the cloud storage account credentials *or* a blob container URL that includes a shared access signature (SAS)."},{"content":"The template includes support for providing credentials via common environment variables.","pos":[27116,27205]},{"content":"Your client can pass the storage credentials as follows:","pos":[27206,27262]},{"pos":[27474,27588],"content":"The storage account is then available in the TaskProcessor class via the <ph id=\"ph1\">`_configuration.StorageAccount`</ph> property.","source":"The storage account is then available in the TaskProcessor class via the `_configuration.StorageAccount` property."},{"content":"If you prefer to use a container URL with SAS, you can also pass this via an job common environment setting, but the task processor template does not currently include built-in support for this.","pos":[27590,27784]},{"content":"Storage setup","pos":[27788,27801]},{"content":"It is recommended that the client or job manager task create any containers required by tasks before adding the tasks to the job.","pos":[27805,27934]},{"content":"This is mandatory if you use a container URL with SAS, as such a URL does not include permission to create the container.","pos":[27935,28056]},{"content":"It is recommended even if you pass storage account credentials, as it saves every task having to call CloudBlobContainer.CreateIfNotExistsAsync on the container.","pos":[28057,28218]},{"content":"Pass parameters and environment variables","pos":[28223,28264]},{"content":"Pass environment settings","pos":[28270,28295]},{"content":"A client can pass information to the job manager task in the form of environment settings.","pos":[28297,28387]},{"content":"This information can then be used by the job manager task when generating the task processor tasks that will run as part of the compute job.","pos":[28388,28528]},{"content":"Examples of the information that you can pass as environment settings are:","pos":[28529,28603]},{"content":"Storage account name and account keys","pos":[28607,28644]},{"content":"Batch account URL","pos":[28647,28664]},{"content":"Batch account key","pos":[28667,28684]},{"pos":[28686,28884],"content":"The Batch service has a simple mechanism to pass environment settings to a job manager task by using the <ph id=\"ph1\">`EnvironmentSettings`</ph> property in <bpt id=\"p1\">[</bpt>Microsoft.Azure.Batch.JobManagerTask<ept id=\"p1\">]</ept><bpt id=\"p2\">[</bpt>net_jobmanagertask<ept id=\"p2\">]</ept>.","source":"The Batch service has a simple mechanism to pass environment settings to a job manager task by using the `EnvironmentSettings` property in [Microsoft.Azure.Batch.JobManagerTask][net_jobmanagertask]."},{"content":"For example, to get the <ph id=\"ph1\">`BatchClient`</ph> instance for a Batch account, you can pass as environment variables from the client code the URL and shared key credentials for the Batch account.","pos":[28886,29070],"source":"For example, to get the `BatchClient` instance for a Batch account, you can pass as environment variables from the client code the URL and shared key credentials for the Batch account."},{"content":"Likewise, to access the storage account that is linked to the Batch account, you can pass the storage account name and the storage account key as environment variables.","pos":[29071,29239]},{"content":"Pass parameters to the Job Manager template","pos":[29245,29288]},{"content":"In many cases, it's useful to pass per-job parameters to the job manager task, either to control the job splitting process or to configure the tasks for the job.","pos":[29290,29451]},{"content":"You can do this by uploading a JSON file named parameters.json as a resource file for the job manager task.","pos":[29452,29559]},{"content":"The parameters can then become available in the <ph id=\"ph1\">`JobSplitter._parameters`</ph> field in the Job Manager template.","pos":[29560,29668],"source":" The parameters can then become available in the `JobSplitter._parameters` field in the Job Manager template."},{"content":"The built-in parameter handler supports only string-to-string dictionaries.","pos":[29684,29759]},{"content":"If you want to pass complex JSON values as parameter values, you will need to pass these as strings and parse them in the job splitter, or modify the framework's <ph id=\"ph1\">`Configuration.GetJobParameters`</ph> method.","pos":[29760,29962],"source":" If you want to pass complex JSON values as parameter values, you will need to pass these as strings and parse them in the job splitter, or modify the framework's `Configuration.GetJobParameters` method."},{"content":"Pass parameters to the Task Processor template","pos":[29968,30014]},{"content":"You can also pass parameters to individual tasks implemented using the Task Processor template.","pos":[30016,30111]},{"content":"Just as with the job manager template, the task processor template looks for a resource file named","pos":[30112,30210]},{"content":"parameters.json, and if found it loads it as the parameters dictionary.","pos":[30212,30283]},{"content":"There are a couple of options for how to pass parameters to the task processor tasks:","pos":[30284,30369]},{"content":"Reuse the job parameters JSON.","pos":[30373,30403]},{"content":"This works well if the only parameters are job-wide ones (for example, a render height and width).","pos":[30404,30502]},{"content":"To do this, when creating a CloudTask in the job splitter, add a reference to the parameters.json resource file object from the job manager task's ResourceFiles (<ph id=\"ph1\">`JobSplitter._jobManagerTask.ResourceFiles`</ph>) to the CloudTask's ResourceFiles collection.","pos":[30503,30754],"source":" To do this, when creating a CloudTask in the job splitter, add a reference to the parameters.json resource file object from the job manager task's ResourceFiles (`JobSplitter._jobManagerTask.ResourceFiles`) to the CloudTask's ResourceFiles collection."},{"content":"Generate and upload a task-specific parameters.json document as part of job splitter execution, and reference that blob in the task's resource files collection.","pos":[30758,30918]},{"content":"This is necessary if different tasks have different parameters.","pos":[30919,30982]},{"content":"An example might be a 3D rendering scenario where the frame index is passed to the task as a parameter.","pos":[30983,31086]},{"content":"The built-in parameter handler supports only string-to-string dictionaries.","pos":[31102,31177]},{"content":"If you want to pass complex JSON values as parameter values, you will need to pass these as strings and parse them in the task processor, or modify the framework's <ph id=\"ph1\">`Configuration.GetTaskParameters`</ph> method.","pos":[31178,31383],"source":" If you want to pass complex JSON values as parameter values, you will need to pass these as strings and parse them in the task processor, or modify the framework's `Configuration.GetTaskParameters` method."},{"content":"Next steps","pos":[31388,31398]},{"content":"Persist job and task output to Azure Storage","pos":[31404,31448]},{"content":"Another helpful tool in Batch solution development is <bpt id=\"p1\">[</bpt>Azure Batch File Conventions<ept id=\"p1\">]</ept><bpt id=\"p2\">[</bpt>nuget_package<ept id=\"p2\">]</ept>.","pos":[31450,31550],"source":"Another helpful tool in Batch solution development is [Azure Batch File Conventions][nuget_package]."},{"content":"Use this .NET class library (currently in preview) in your Batch .NET applications to easily store and retrieve task outputs to and from Azure Storage.","pos":[31551,31702]},{"content":"<bpt id=\"p1\">[</bpt>Persist Azure Batch job and task output<ept id=\"p1\">](batch-task-output.md)</ept> contains a full discussion of the library and its usage.","pos":[31703,31823],"source":"[Persist Azure Batch job and task output](batch-task-output.md) contains a full discussion of the library and its usage."},{"content":"Batch Forum","pos":[31829,31840]},{"content":"The <bpt id=\"p1\">[</bpt>Azure Batch Forum<ept id=\"p1\">]</ept><bpt id=\"p2\">[</bpt>forum<ept id=\"p2\">]</ept> on MSDN is a great place to discuss Batch and ask questions about the service.","pos":[31842,31951],"source":"The [Azure Batch Forum][forum] on MSDN is a great place to discuss Batch and ask questions about the service."},{"content":"Head on over for helpful \"sticky\" posts, and post your questions as they arise while you build your Batch solutions.","pos":[31952,32068]},{"content":"forum","pos":[32071,32076]},{"content":"net_jobmanagertask","pos":[32155,32173]},{"content":"github_samples","pos":[32260,32274]},{"content":"nuget_package","pos":[32323,32336]},{"content":"process_exitcode","pos":[32411,32427]},{"content":"vs_gallery","pos":[32507,32517]},{"content":"vs_gallery_templates","pos":[32569,32589]},{"content":"vs_find_use_ext","pos":[32640,32655]},{"content":"diagram01","pos":[32709,32718]},{"content":"solution_explorer01","pos":[32774,32793]},{"content":"solution_explorer02","pos":[32859,32878]}],"content":"<properties\n    pageTitle=\"Visual Studio templates for Azure Batch | Microsoft Azure\"\n    description=\"Learn how these Visual Studio project templates can help you implement and run your compute-intensive workloads on Azure Batch\"\n    services=\"batch\"\n    documentationCenter=\".net\"\n    authors=\"fayora\"\n    manager=\"timlt\"\n    editor=\"\" />\n\n<tags\n    ms.service=\"batch\"\n    ms.devlang=\"multiple\"\n    ms.topic=\"article\"\n    ms.tgt_pltfrm=\"vm-windows\"\n    ms.workload=\"big-compute\"\n    ms.date=\"09/07/2016\"\n    ms.author=\"marsma\" />\n\n# Visual Studio project templates for Azure Batch\n\nThe **Job Manager** and **Task Processor Visual Studio templates** for Batch provide code to help you to implement and run your compute-intensive workloads on Batch with the least amount of effort. This document describes these templates and provides guidance for how to use them.\n\n>[AZURE.IMPORTANT] This article discusses only information applicable to these two templates, and assumes that you are familiar with the Batch service and key concepts related to it: pools, compute nodes, jobs and tasks, job manager tasks, environment variables, and other relevant information. You can find more information in [Basics of Azure Batch](batch-technical-overview.md), [Batch feature overview for developers](batch-api-basics.md), and [Get started with the Azure Batch library for .NET](batch-dotnet-get-started.md).\n\n## High-level overview\n\nThe Job Manager and Task Processor templates can be used to create two useful components:\n\n* A job manager task that implements a job splitter that can break a job down into multiple tasks that can run independently, in parallel.\n\n* A task processor that can be used to perform pre-processing and post-processing around an application command line.\n\nFor example, in a movie rendering scenario, the job splitter would turn a single movie job into hundreds or thousands of separate tasks that would process individual frames separately. Correspondingly, the task processor would invoke the rendering application and all dependent processes that are needed to render each frame, as well as perform any additional actions (for example, copying the rendered frame to a storage location).\n\n>[AZURE.NOTE] The Job Manager and Task Processor templates are independent of each other, so you can choose to use both, or only one of them, depending on the requirements of your compute job and on your preferences.\n\nAs shown in the diagram below, a compute job that uses these templates will go through three stages:\n\n1. The client code (e.g., application, web service, etc.) submits a job to the Batch service on Azure, specifying as its job manager task the job manager program.\n\n2. The Batch service runs the job manager task on a compute node and the job splitter launches the specified number of task processor tasks, on as many compute nodes as required, based on the parameters and specifications in the job splitter code.\n\n3. The task processor tasks run independently, in parallel, to process the input data and generate the output data.\n\n![Diagram showing how client code interacts with the Batch service][diagram01]\n\n## Prerequisites\n\nTo use the Batch templates, you will need the following:\n\n* A computer with Visual Studio 2015, or newer, already installed on it.\n\n* The Batch templates, which are available from the [Visual Studio Gallery][vs_gallery] as Visual Studio extensions. There are two ways to get the templates:\n\n  * Install the templates using the **Extensions and Updates** dialog box in Visual Studio (for more information, see [Finding and Using Visual Studio Extensions][vs_find_use_ext]). In the **Extensions and Updates** dialog box, search and download the following two extensions:\n\n    * Azure Batch Job Manager with Job Splitter\n    * Azure Batch Task Processor\n\n  * Download the templates from the online gallery for Visual Studio: [Microsoft Azure Batch Project Templates][vs_gallery_templates]\n\n* If you plan to use the [Application Packages](batch-application-packages.md) feature to deploy the job manager and task processor to the Batch compute nodes, you need to link a storage account to your Batch account.\n\n## Preparation\n\nWe recommend creating a solution that can contain your job manager as well as your task processor, because this can make it easier to share code between your job manager and task processor programs. To create this solution, follow these steps:\n\n1. Open Visual Studio 2015 and select **File** > **New** > **Project**.\n\n2. Under **Templates**, expand **Other Project Types**, click **Visual Studio Solutions**, and then select **Blank Solution**.\n\n3. Type a name that describes your application and the purpose of this solution (e.g., \"LitwareBatchTaskPrograms\").\n\n4. To create the new solution, click **OK**.\n\n## Job Manager template\n\nThe Job Manager template helps you to implement a job manager task that can perform the following actions:\n\n* Split a job into multiple tasks.\n* Submit those tasks to run on Batch.\n\n>[AZURE.NOTE] For more information about job manager tasks, see [Batch feature overview for developers](batch-api-basics.md#job-manager-task).\n\n### Create a Job Manager using the template\n\nTo add a job manager to the solution that you created earlier, follow these steps:\n\n1. Open your existing solution in Visual Studio 2015.\n\n2. In Solution Explorer, right-click the solution, click **Add** > **New Project**.\n\n3. Under **Visual C#**, click **Cloud**, and then click **Azure Batch Job Manager with Job Splitter**.\n\n4. Type a name that describes your application and identifies this project as the job manager (e.g. \"LitwareJobManager\").\n\n5. To create the project, click **OK**.\n\n6. Finally, build the project to force Visual Studio to load all referenced NuGet packages and to verify that the project is valid before you start modifying it.\n\n### Job Manager template files and their purpose\n\nWhen you create a project using the Job Manager template, it generates three groups of code files:\n\n* The main program file (Program.cs). This contains the program entry point and top-level exception handling. You shouldn't normally need to modify this.\n\n* The Framework directory. This contains the files responsible for the 'boilerplate' work done by the job manager program – unpacking parameters, adding tasks to the Batch job, etc. You shouldn't normally need to modify these files.\n\n* The job splitter file (JobSplitter.cs). This is where you will put your application-specific logic for splitting a job into tasks.\n\nOf course you can add additional files as required to support your job splitter code, depending on the complexity of the job splitting logic.\n\nThe template also generates standard .NET project files such as a .csproj file, app.config, packages.config, etc.\n\nThe rest of this section describes the different files and their code structure, and explains what each class does.\n\n![Visual Studio Solution Explorer showing the Job Manager template solution][solution_explorer01]\n\n**Framework files**\n\n* `Configuration.cs`: Encapsulates the loading of job configuration data such as Batch account details, linked storage account credentials, job and task information, and job parameters. It also provides access to Batch-defined environment variables (see Environment settings for tasks, in the Batch documentation) via the Configuration.EnvironmentVariable class.\n\n* `IConfiguration.cs`: Abstracts the implementation of the Configuration class, so that you can unit test your job splitter using a fake or mock configuration object.\n\n* `JobManager.cs`: Orchestrates the components of the job manager program. It is responsible for the initializing the job splitter, invoking the job splitter, and dispatching the tasks returned by the job splitter to the task submitter.\n\n* `JobManagerException.cs`: Represents an error that requires the job manager to terminate. JobManagerException is used to wrap 'expected' errors where specific diagnostic information can be provided as part of termination.\n\n* `TaskSubmitter.cs`: This class is responsible to adding tasks returned by the job splitter to the Batch job. The JobManager class aggregates the sequence of tasks into batches for efficient but timely addition to the job, then calls TaskSubmitter.SubmitTasks on a background thread for each batch.\n\n**Job Splitter**\n\n`JobSplitter.cs`: This class contains application-specific logic for splitting the job into tasks. The framework invokes the JobSplitter.Split method to obtain a sequence of tasks, which it adds to the job as the method returns them. This is the class where you will inject the logic of your job. Implement the Split method to return a sequence of CloudTask instances representing the tasks into which you want to partition the job.\n\n**Standard .NET command line project files**\n\n* `App.config`: Standard .NET application configuration file.\n\n* `Packages.config`: Standard NuGet package dependency file.\n\n* `Program.cs`: Contains the program entry point and top-level exception handling.\n\n### Implementing the job splitter\n\nWhen you open the Job Manager template project, the project will have the JobSplitter.cs file open by default. You can implement the split logic for the tasks in your workload by using the Split() method show below:\n\n```csharp\n/// <summary>\n/// Gets the tasks into which to split the job. This is where you inject\n/// your application-specific logic for decomposing the job into tasks.\n///\n/// The job manager framework invokes the Split method for you; you need\n/// only to implement it, not to call it yourself. Typically, your\n/// implementation should return tasks lazily, for example using a C#\n/// iterator and the \"yield return\" statement; this allows tasks to be added\n/// and to start running while splitting is still in progress.\n/// </summary>\n/// <returns>The tasks to be added to the job. Tasks are added automatically\n/// by the job manager framework as they are returned by this method.</returns>\npublic IEnumerable<CloudTask> Split()\n{\n    // Your code for the split logic goes here.\n    int startFrame = Convert.ToInt32(_parameters[\"StartFrame\"]);\n    int endFrame = Convert.ToInt32(_parameters[\"EndFrame\"]);\n\n    for (int i = startFrame; i <= endFrame; i++)\n    {\n        yield return new CloudTask(\"myTask\" + i, \"cmd /c dir\");\n    }\n}\n```\n\n>[AZURE.NOTE] The annotated section in the `Split()` method is the only section of the Job Manager template code that is intended for you to modify by adding the logic to split your jobs into different tasks. If you want to modify a different section of the template, please ensure you are familiarized with how Batch works, and try out a few of the [Batch code samples][github_samples].\n\nYour Split() implementation has access to:\n\n* The job parameters, via the `_parameters` field.\n* The CloudJob object representing the job, via the `_job` field.\n* The CloudTask object representing the job manager task, via the `_jobManagerTask` field.\n\nYour `Split()` implementation does not need to add tasks to the job directly. Instead, your code should return a sequence of CloudTask objects, and these will be added to the job automatically by the framework classes that invoke the job splitter. It's common to use C#'s iterator (`yield return`) feature to implement job splitters as this allows the tasks to start running as soon as possible rather than waiting for all tasks to be calculated.\n\n**Job splitter failure**\n\nIf your job splitter encounters an error, it should either:\n\n* Terminate the sequence using the C# `yield break` statement, in which case the job manager will be treated as successful; or\n\n* Throw an exception, in which case the job manager will be treated as failed and may be retried depending on how the client has configured it).\n\nIn both cases, any tasks already returned by the job splitter and added to the Batch job will be eligible to run. If you don't want this to happen, then you could:\n\n* Terminate the job before returning from the job splitter\n\n* Formulate the entire task collection before returning it (that is, return an `ICollection<CloudTask>` or `IList<CloudTask>` instead of implementing your job splitter using a C# iterator)\n\n* Use task dependencies to make all tasks depend on the successful completion of the job manager\n\n**Job manager retries**\n\nIf the job manager fails, it may be retried by the Batch service depending on the client retry settings. In general, this is safe, because when the framework adds tasks to the job, it ignores any tasks that already exist. However, if calculating tasks is expensive, you may not wish to incur the cost of recalculating tasks that have already been added to the job; conversely, if the re-run is not guaranteed to generate the same task IDs then the 'ignore duplicates' behavior will not kick in. In these cases you should design your job splitter to detect the work that has already been done and not repeat it, for example by performing a CloudJob.ListTasks before starting to yield tasks.\n\n### Exit codes and exceptions in the Job Manager template\n\nExit codes and exceptions provide a mechanism to determine the outcome of running a program, and they can help to identify any problems with the execution of the program. The Job Manager template implements the exit codes and exceptions described in this section.\n\nA job manager task that is implemented with the Job Manager template can return three possible exit codes:\n\n| Code | Description |\n|------|-------------|\n| 0    | The job manager completed successfully. Your job splitter code ran to completion, and all tasks were added to the job. |\n| 1    | The job manager task failed with an exception in an 'expected' part of the program. The exception was translated to a JobManagerException with diagnostic information and, where possible, suggestions for resolving the failure. |\n| 2    | The job manager task failed with an 'unexpected' exception. The exception was logged to standard output, but the job manager was unable to add any additional diagnostic or remediation information. |\n\nIn the case of job manager task failure, some tasks may still have been added to the service before the error occurred. These tasks will run as normal. See \"Job Splitter Failure\" above for discussion of this code path.\n\nAll the information returned by exceptions is written into stdout.txt and stderr.txt files. For more information, see [Error Handling](batch-api-basics.md#error-handling).\n\n### Client considerations\n\nThis section describes some client implementation requirements when invoking a job manager based on this template. See [How to pass parameters and environment variables from the client code](#pass-environment-settings) for details on passing parameters and environment settings.\n\n**Mandatory credentials**\n\nIn order to add tasks to the Azure Batch job, the job manager task requires your Azure Batch account URL and key. You must pass these in environment variables named YOUR_BATCH_URL and YOUR_BATCH_KEY. You can set these in the Job Manager task environment settings. For example, in a C# client:\n\n```csharp\njob.JobManagerTask.EnvironmentSettings = new [] {\n    new EnvironmentSetting(\"YOUR_BATCH_URL\", \"https://account.region.batch.azure.com\"),\n    new EnvironmentSetting(\"YOUR_BATCH_KEY\", \"{your_base64_encoded_account_key}\"),\n};\n```\n**Storage credentials**\n\nTypically, the client does not need to provide the linked storage account credentials to the job manager task because (a) most job managers do not need to explicitly access the linked storage account and (b) the linked storage account is often provided to all tasks as a common environment setting for the job. If you are not providing the linked storage account via the common environment settings, and the job manager requires access to linked storage, then you should supply the linked storage credentials as follows:\n\n```csharp\njob.JobManagerTask.EnvironmentSettings = new [] {\n    /* other environment settings */\n    new EnvironmentSetting(\"LINKED_STORAGE_ACCOUNT\", \"{storageAccountName}\"),\n    new EnvironmentSetting(\"LINKED_STORAGE_KEY\", \"{storageAccountKey}\"),\n};\n```\n\n**Job manager task settings**\n\nThe client should set the job manager *killJobOnCompletion* flag to **false**.\n\nIt is usually safe for the client to set *runExclusive* to **false**.\n\nThe client should use the *resourceFiles* or *applicationPackageReferences* collection to have the job manager executable (and its required DLLs) deployed to the compute node.\n\nBy default, the job manager will not be retried if it fails. Depending on your job manager logic, the client may want to enable retries via *constraints*/*maxTaskRetryCount*.\n\n**Job settings**\n\nIf the job splitter emits tasks with dependencies, the client must set the job's usesTaskDependencies to true.\n\nIn the job splitter model, it is unusual for clients to wish to add tasks to jobs over and above what the job splitter creates. The client should therefore normally set the job's *onAllTasksComplete* to **terminatejob**.\n\n## Task Processor template\n\nA Task Processor template helps you to implement a task processor that can perform the following actions:\n\n* Set up the information required by each Batch task to run.\n* Run all actions required by each Batch task.\n* Save task outputs to persistent storage.\n\nAlthough a task processor is not required to run tasks on Batch, the key advantage of using a task processor is that it provides a wrapper to implement all task execution actions in one location. For example, if you need to run several applications in the context of each task, or if you need to copy data to persistent storage after completing each task.\n\nThe actions performed by the task processor can be as simple or complex, and as many or as few, as required by your workload. Additionally, by implementing all task actions into one task processor, you can readily update or add actions based on changes to applications or workload requirements. However, in some cases a task processor might not be the optimal solution for your implementation as it can add unnecessary complexity, for example when running jobs that can be quickly started from a simple command line.\n\n### Create a Task Processor using the template\n\nTo add a task processor to the solution that you created earlier, follow these steps:\n\n1. Open your existing solution in Visual Studio 2015.\n\n2. In Solution Explorer, right-click the solution, click **Add**, and then click **New Project**.\n\n3. Under **Visual C#**, click **Cloud**, and then click **Azure Batch Task Processor**.\n\n4. Type a name that describes your application and identifies this project as the task processor (e.g. \"LitwareTaskProcessor\").\n\n5. To create the project, click **OK**.\n\n6. Finally, build the project to force Visual Studio to load all referenced NuGet packages and to verify that the project is valid before you start modifying it.\n\n### Task Processor template files and their purpose\n\nWhen you create a project using the task processor template, it generates three groups of code files:\n\n* The main program file (Program.cs). This contains the program entry point and top-level exception handling. You shouldn't normally need to modify this.\n\n* The Framework directory. This contains the files responsible for the 'boilerplate' work done by the job manager program – unpacking parameters, adding tasks to the Batch job, etc. You shouldn't normally need to modify these files.\n\n* The task processor file (TaskProcessor.cs). This is where you will put your application-specific logic for executing a task (typically by calling out to an existing executable). Pre- and post-processing code, such as downloading additional data or uploading result files, also goes here.\n\nOf course you can add additional files as required to support your task processor code, depending on the complexity of the job splitting logic.\n\nThe template also generates standard .NET project files such as a .csproj file, app.config, packages.config, etc.\n\nThe rest of this section describes the different files and their code structure, and explains what each class does.\n\n![Visual Studio Solution Explorer showing the Task Processor template solution][solution_explorer02]\n\n**Framework files**\n\n* `Configuration.cs`: Encapsulates the loading of job configuration data such as Batch account details, linked storage account credentials, job and task information, and job parameters. It also provides access to Batch-defined environment variables (see Environment settings for tasks, in the Batch documentation) via the Configuration.EnvironmentVariable class.\n\n* `IConfiguration.cs`: Abstracts the implementation of the Configuration class, so that you can unit test your job splitter using a fake or mock configuration object.\n\n* `TaskProcessorException.cs`: Represents an error that requires the job manager to terminate. TaskProcessorException is used to wrap 'expected' errors where specific diagnostic information can be provided as part of termination.\n\n**Task Processor**\n\n* `TaskProcessor.cs`: Runs the task. The framework invokes the TaskProcessor.Run method. This is the class where you will inject the application-specific logic of your task. Implement the Run method to:\n  * Parse and validate any task parameters\n  * Compose the command line for any external program you want to invoke\n  * Log any diagnostic information you may require for debugging purposes\n  * Start a process using that command line\n  * Wait for the process to exit\n  * Capture the exit code of the process to determine if it succeeded or failed\n  * Save any output files you want to keep to persistent storage\n\n**Standard .NET command line project files**\n\n* `App.config`: Standard .NET application configuration file.\n* `Packages.config`: Standard NuGet package dependency file.\n* `Program.cs`: Contains the program entry point and top-level exception handling.\n\n## Implementing the task processor\n\nWhen you open the Task Processor template project, the project will have the TaskProcessor.cs file open by default. You can implement the run logic for the tasks in your workload by using the Run() method shown below:\n\n```csharp\n/// <summary>\n/// Runs the task processing logic. This is where you inject\n/// your application-specific logic for decomposing the job into tasks.\n///\n/// The task processor framework invokes the Run method for you; you need\n/// only to implement it, not to call it yourself. Typically, your\n/// implementation will execute an external program (from resource files or\n/// an application package), check the exit code of that program and\n/// save output files to persistent storage.\n/// </summary>\npublic async Task<int> Run()\n\n{\n    try\n    {\n        //Your code for the task processor goes here.\n        var command = $\"compare {_parameters[\"Frame1\"]} {_parameters[\"Frame2\"]} compare.gif\";\n        using (var process = Process.Start($\"cmd /c {command}\"))\n        {\n            process.WaitForExit();\n            var taskOutputStorage = new TaskOutputStorage(\n            _configuration.StorageAccount,\n            _configuration.JobId,\n            _configuration.TaskId\n            );\n            await taskOutputStorage.SaveAsync(\n            TaskOutputKind.TaskOutput,\n            @\"..\\stdout.txt\",\n            @\"stdout.txt\"\n            );\n            return process.ExitCode;\n        }\n    }\n    catch (Exception ex)\n    {\n        throw new TaskProcessorException(\n        $\"{ex.GetType().Name} exception in run task processor: {ex.Message}\",\n        ex\n        );\n    }\n}\n```\n>[AZURE.NOTE] The annotated section in the Run() method is the only section of the Task Processor template code that is intended for you to modify by adding the run logic for the tasks in your workload. If you want to modify a different section of the template, please first familiarize yourself with how Batch works by reviewing the Batch documentation and trying out a few of the Batch code samples.\n\nThe Run() method is responsible for launching the command line, starting one or more processes, waiting for all process to complete, saving the results, and finally returning with an exit code. The Run() method is where you implement the processing logic for your tasks. The task processor framework invokes the Run() method for you; you do not need to call it yourself.\n\nYour Run() implementation has access to:\n\n* The task parameters, via the `_parameters` field.\n* The job and task ids, via the `_jobId` and `_taskId` fields.\n* The task configuration, via the `_configuration` field.\n\n**Task failure**\n\nIn case of failure, you can exit the Run() method by throwing an exception, but this leaves the top level exception handler in control of the task exit code. If you need to control the exit code so that you can distinguish different types of failure, for example for diagnostic purposes or because some failure modes should terminate the job and others should not, then you should exit the Run() method by returning a non-zero exit code. This becomes the task exit code.\n\n### Exit codes and exceptions in the Task Processor template\n\nExit codes and exceptions provide a mechanism to determine the outcome of running a program, and they can help identify any problems with the execution of the program. The Task Processor template implements the exit codes and exceptions described in this section.\n\nA task processor task that is implemented with the Task Processor template can return three possible exit codes:\n\n| Code | Description |\n|------|-------------|\n|  [Process.ExitCode][process_exitcode] | The task processor ran to completion. Note that this does not imply that the program you invoked was successful – only that the task processor invoked it successfully and performed any post-processing without exceptions. The meaning of the exit code depends on the invoked program – typically exit code 0 means the program succeeded and any other exit code means the program failed. |\n| 1    | The task processor failed with an exception in an 'expected' part of the program. The exception was translated to a `TaskProcessorException` with diagnostic information and, where possible, suggestions for resolving the failure. |\n| 2    | The task processor failed with an 'unexpected' exception. The exception was logged to standard output, but the task processor was unable to add any additional diagnostic or remediation information. |\n\n>[AZURE.NOTE] If the program you invoke uses exit codes 1 and 2 to indicate specific failure modes, then using exit codes 1 and 2 for task processor errors is ambiguous. You can change these task processor error codes to distinctive exit codes by editing the exception cases in the Program.cs file.\n\nAll the information returned by exceptions is written into stdout.txt and stderr.txt files. For more information, see Error Handling, in the Batch documentation.\n\n### Client considerations\n\n**Storage credentials**\n\nIf your task processor uses Azure blob storage to persist outputs, for example using the file conventions helper library, then it needs access to *either* the cloud storage account credentials *or* a blob container URL that includes a shared access signature (SAS). The template includes support for providing credentials via common environment variables. Your client can pass the storage credentials as follows:\n\n```csharp\njob.CommonEnvironmentSettings = new [] {\n    new EnvironmentSetting(\"LINKED_STORAGE_ACCOUNT\", \"{storageAccountName}\"),\n    new EnvironmentSetting(\"LINKED_STORAGE_KEY\", \"{storageAccountKey}\"),\n};\n```\n\nThe storage account is then available in the TaskProcessor class via the `_configuration.StorageAccount` property.\n\nIf you prefer to use a container URL with SAS, you can also pass this via an job common environment setting, but the task processor template does not currently include built-in support for this.\n\n**Storage setup**\n\nIt is recommended that the client or job manager task create any containers required by tasks before adding the tasks to the job. This is mandatory if you use a container URL with SAS, as such a URL does not include permission to create the container. It is recommended even if you pass storage account credentials, as it saves every task having to call CloudBlobContainer.CreateIfNotExistsAsync on the container.\n\n## Pass parameters and environment variables\n\n### Pass environment settings\n\nA client can pass information to the job manager task in the form of environment settings. This information can then be used by the job manager task when generating the task processor tasks that will run as part of the compute job. Examples of the information that you can pass as environment settings are:\n\n* Storage account name and account keys\n* Batch account URL\n* Batch account key\n\nThe Batch service has a simple mechanism to pass environment settings to a job manager task by using the `EnvironmentSettings` property in [Microsoft.Azure.Batch.JobManagerTask][net_jobmanagertask].\n\nFor example, to get the `BatchClient` instance for a Batch account, you can pass as environment variables from the client code the URL and shared key credentials for the Batch account. Likewise, to access the storage account that is linked to the Batch account, you can pass the storage account name and the storage account key as environment variables.\n\n### Pass parameters to the Job Manager template\n\nIn many cases, it's useful to pass per-job parameters to the job manager task, either to control the job splitting process or to configure the tasks for the job. You can do this by uploading a JSON file named parameters.json as a resource file for the job manager task. The parameters can then become available in the `JobSplitter._parameters` field in the Job Manager template.\n\n>[AZURE.NOTE] The built-in parameter handler supports only string-to-string dictionaries. If you want to pass complex JSON values as parameter values, you will need to pass these as strings and parse them in the job splitter, or modify the framework's `Configuration.GetJobParameters` method.\n\n### Pass parameters to the Task Processor template\n\nYou can also pass parameters to individual tasks implemented using the Task Processor template. Just as with the job manager template, the task processor template looks for a resource file named\n\nparameters.json, and if found it loads it as the parameters dictionary. There are a couple of options for how to pass parameters to the task processor tasks:\n\n* Reuse the job parameters JSON. This works well if the only parameters are job-wide ones (for example, a render height and width). To do this, when creating a CloudTask in the job splitter, add a reference to the parameters.json resource file object from the job manager task's ResourceFiles (`JobSplitter._jobManagerTask.ResourceFiles`) to the CloudTask's ResourceFiles collection.\n\n* Generate and upload a task-specific parameters.json document as part of job splitter execution, and reference that blob in the task's resource files collection. This is necessary if different tasks have different parameters. An example might be a 3D rendering scenario where the frame index is passed to the task as a parameter.\n\n>[AZURE.NOTE] The built-in parameter handler supports only string-to-string dictionaries. If you want to pass complex JSON values as parameter values, you will need to pass these as strings and parse them in the task processor, or modify the framework's `Configuration.GetTaskParameters` method.\n\n## Next steps\n\n### Persist job and task output to Azure Storage\n\nAnother helpful tool in Batch solution development is [Azure Batch File Conventions][nuget_package]. Use this .NET class library (currently in preview) in your Batch .NET applications to easily store and retrieve task outputs to and from Azure Storage. [Persist Azure Batch job and task output](batch-task-output.md) contains a full discussion of the library and its usage.\n\n### Batch Forum\n\nThe [Azure Batch Forum][forum] on MSDN is a great place to discuss Batch and ask questions about the service. Head on over for helpful \"sticky\" posts, and post your questions as they arise while you build your Batch solutions.\n\n[forum]: https://social.msdn.microsoft.com/forums/azure/en-US/home?forum=azurebatch\n[net_jobmanagertask]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.jobmanagertask.aspx\n[github_samples]: https://github.com/Azure/azure-batch-samples\n[nuget_package]: https://www.nuget.org/packages/Microsoft.Azure.Batch.Conventions.Files\n[process_exitcode]: https://msdn.microsoft.com/library/system.diagnostics.process.exitcode.aspx\n[vs_gallery]: https://visualstudiogallery.msdn.microsoft.com/\n[vs_gallery_templates]: https://go.microsoft.com/fwlink/?linkid=820714\n[vs_find_use_ext]: https://msdn.microsoft.com/library/dd293638.aspx\n\n[diagram01]: ./media/batch-visual-studio-templates/diagram01.png\n[solution_explorer01]: ./media/batch-visual-studio-templates/solution_explorer01.png\n[solution_explorer02]: ./media/batch-visual-studio-templates/solution_explorer02.png\n"}